pipeline {
    agent any

    environment {
        APP_NAME = 'main-bank'
        DOCKER_USER = 'denidkr24'
        DOCKER_CRED_ID = 'docker-hub-credentials'
        
        IMAGE_TAG = "${DOCKER_USER}/${APP_NAME}:${env.BUILD_ID}"
        LATEST_TAG = "${DOCKER_USER}/${APP_NAME}:latest"
    }

    stages {
        stage('1. Build Docker Image') {
            steps {
                echo "Memulai tahapan Build untuk Image: ${IMAGE_TAG}"
                
                script {
                    sh "docker image rm -f ${IMAGE_TAG} || true"
                    
                    sh "docker build -t ${IMAGE_TAG} -t ${LATEST_TAG} ."
                    echo "Build Image Selesai: ${IMAGE_TAG} dan ${LATEST_TAG}"
                }
            }
        }

        stage('2. Push to Docker Hub') {
            steps {
                echo "Memulai tahapan Push ke Docker Hub..."
                
                withCredentials([usernamePassword(credentialsId: DOCKER_CRED_ID, 
                                                 passwordVariable: 'DOCKER_PASSWORD', 
                                                 usernameVariable: 'DOCKER_USERNAME')]) {
                    script {
                        sh "echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin"
                        
                        sh "docker push ${IMAGE_TAG}"
                        echo "Image ${IMAGE_TAG} berhasil di-push."
                        sh "docker push ${LATEST_TAG}"
                        echo "Image ${LATEST_TAG} berhasil di-push."

                        sh "docker logout"
                    }
                }
            }
        }

        stage('3. Deploy Application Locally') {
            steps {
                echo "Memulai tahapan Deploy Lokal. Kontainer lama akan dihentikan dan diganti..."
                
                sh """
                    echo "Menghentikan dan menghapus kontainer lama: ${APP_NAME}..."
                    docker stop ${APP_NAME} || true
                    docker rm ${APP_NAME} || true

                    echo "Menjalankan kontainer baru dari image terbaru: ${LATEST_TAG}"
                    
                    docker run -d -p 8888:80 -p 4444:443 --name ${APP_NAME} -v ./certs:/etc/nginx/certs:ro -v ./logs_nginx:/var/log/nginx ${LATEST_TAG}    
                    echo "Deployment Lokal Selesai. Aplikasi berjalan di port 8888 untuk http dan 4444 untuk https."
                """
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline CI/CD Selesai.'
        }
        success {
            echo 'Deployment Berhasil! Image terbaru sudah berjalan secara lokal.'
        }
        failure {
            echo 'Pipeline GAGAL. Periksa log build dan pastikan user Jenkins memiliki akses Docker.'
        }
    }
}